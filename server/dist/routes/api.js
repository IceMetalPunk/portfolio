import { config } from 'dotenv';
import { Router } from 'express';
import { Pool } from 'pg';
import { numericQueryParam, sanitizeDbValuesForHTML } from '../util/util.js';
config();
export const APIRouter = Router();
const connectionString = `postgresql://${process.env.SUPABASE_UN}:${process.env.SUPABASE_PW}@${process.env.SUPABASE_DOMAIN}:${process.env.SUPABASE_PORT}/${process.env.SUPABASE_DB}`;
const pool = new Pool({ connectionString });
async function* getYouTubeResults(url, params) {
    const query = new URLSearchParams(params);
    query.set('channelId', process.env.YT_CHANNEL_ID);
    query.set('key', process.env.YT_API_KEY);
    const fullURL = new URL(url);
    while (true) {
        fullURL.search = query.toString();
        const response = await fetch(fullURL);
        const json = (await response.json());
        if (json.items) {
            for (let item of json.items) {
                yield item;
            }
        }
        if (json.nextPageToken) {
            query.set('pageToken', json.nextPageToken);
        }
        else {
            return;
        }
    }
}
async function* getYouTubeResultsByIds(url, params, ids) {
    const query = new URLSearchParams(params);
    query.set('key', process.env.YT_API_KEY);
    const fullURL = new URL(url);
    let idList = [...ids];
    while (true) {
        const currentIdSet = idList.splice(0, 50);
        query.set('id', currentIdSet.join(','));
        fullURL.search = query.toString();
        const response = await fetch(fullURL);
        const json = (await response.json());
        if (json.items) {
            for (let item of json.items) {
                yield item;
            }
        }
        if (json.nextPageToken) {
            idList = [...ids];
            query.set('pageToken', json.nextPageToken);
        }
        else if (idList.length <= 0) {
            return;
        }
    }
}
const getBestThumbnail = (thumbnails) => {
    const descendingQualityOrder = [
        'maxres',
        'high',
        'default',
        'medium',
        'standard',
    ];
    for (let quality of descendingQualityOrder) {
        if (thumbnails.hasOwnProperty(quality)) {
            return thumbnails[quality];
        }
    }
    return null;
};
const updateVideoCache = async (videos, videoIdType = 'object') => {
    const cachedIds = [];
    for await (let video of videos) {
        let id;
        if (videoIdType === 'object') {
            id = video.id.videoId;
        }
        else {
            id = video.id;
        }
        cachedIds.push(id);
        const title = video.snippet.title;
        const description = video.snippet.description;
        const thumbnail = getBestThumbnail(video.snippet.thumbnails);
        const thumbnailUrl = thumbnail?.url ?? '';
        const etag = video.etag;
        const publishedTime = video.snippet.publishTime ?? video.snippet.publishedAt;
        await pool.query('INSERT INTO synthia_videos (id, title, description, thumbnail_url, published_at, etag) VALUES ($1, $2, $3, $4, $5, $6) ON CONFLICT (id) DO UPDATE SET title=$2, description=$3, thumbnail_url=$4, etag=$6', [id, title, description, thumbnailUrl, publishedTime, etag]);
    }
    await pool.query('UPDATE metadata SET last_video_check=$1 WHERE id=$2', [
        new Date(),
        1,
    ]);
    return cachedIds;
};
const updateVideoDescriptions = async (allIds) => {
    if (allIds.length <= 0) {
        return;
    }
    const url = 'https://www.googleapis.com/youtube/v3/videos';
    const params = {
        part: 'snippet',
    };
    const videoDescriptions = getYouTubeResultsByIds(url, params, allIds);
    await updateVideoCache(videoDescriptions, 'string');
};
APIRouter.get('/getLatestVideos', async (req, res) => {
    const url = 'https://www.googleapis.com/youtube/v3/search';
    const params = {
        part: 'snippet',
        maxResults: '50',
        order: 'date',
        q: 'Synthia',
        type: 'video',
    };
    const lastCheckResult = await pool.query('SELECT * FROM metadata');
    if (lastCheckResult &&
        lastCheckResult.rowCount &&
        lastCheckResult.rowCount > 0) {
        const lastCheck = lastCheckResult.rows[0].last_video_check;
        params.publishedAfter = lastCheck.toISOString();
    }
    const videos = getYouTubeResults(url, params);
    const newResultIds = await updateVideoCache(videos);
    if (newResultIds.length > 0) {
        await updateVideoDescriptions(newResultIds);
        console.log('Found ' + newResultIds.length.toString() + ' new videos and cached them.');
    }
    else {
        console.log('No new videos; returning only cached data.');
    }
    const limit = numericQueryParam(req, 'limit', 0);
    const offset = (numericQueryParam(req, 'page', 1) - 1) * limit;
    const allVideos = await pool.query('SELECT * FROM synthia_videos ORDER BY published_at DESC LIMIT $1 OFFSET $2', [limit > 0 ? limit : null, offset]);
    sanitizeDbValuesForHTML(allVideos);
    res.json(allVideos.rows);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3JvdXRlcy9hcGkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUNoQyxPQUFPLEVBQXFCLE1BQU0sRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNwRCxPQUFPLEVBQUUsSUFBSSxFQUErQixNQUFNLElBQUksQ0FBQztBQVV2RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM3RSxNQUFNLEVBQUUsQ0FBQztBQUNULE1BQU0sQ0FBQyxNQUFNLFNBQVMsR0FBVyxNQUFNLEVBQUUsQ0FBQztBQUUxQyxNQUFNLGdCQUFnQixHQUFHLGdCQUFnQixPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO0FBQ3JMLE1BQU0sSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO0FBRTVDLEtBQUssU0FBUyxDQUFDLENBQUMsaUJBQWlCLENBQy9CLEdBQVcsRUFDWCxNQUE4QjtJQUU5QixNQUFNLEtBQUssR0FBRyxJQUFJLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUMxQyxLQUFLLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQXVCLENBQUMsQ0FBQztJQUM1RCxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQW9CLENBQUMsQ0FBQztJQUNuRCxNQUFNLE9BQU8sR0FBUSxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FB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