import { config } from 'dotenv';
import { Router } from 'express';
import { Pool } from 'pg';
config();
export const APIRouter = Router();
const connectionString = `postgresql://${process.env.SUPABASE_UN}:${process.env.SUPABASE_PW}@${process.env.SUPABASE_DOMAIN}:${process.env.SUPABASE_PORT}/${process.env.SUPABASE_DB}`;
const pool = new Pool({ connectionString });
async function* getYouTubeResults(url, params) {
    const query = new URLSearchParams(params);
    query.set('channelId', process.env.YT_CHANNEL_ID);
    query.set('key', process.env.YT_API_KEY);
    while (true) {
        const response = await fetch(url + '?' + query.toString());
        const json = (await response.json());
        if (json.items) {
            for (let item of json.items) {
                yield item;
            }
        }
        if (json.nextPageToken) {
            query.set('pageToken', json.nextPageToken);
        }
        else {
            return;
        }
    }
}
const getBestThumbnail = (thumbnails) => {
    const descendingQualityOrder = [
        'maxres',
        'high',
        'default',
        'medium',
        'standard',
    ];
    for (let quality of descendingQualityOrder) {
        if (thumbnails.hasOwnProperty(quality)) {
            return thumbnails[quality];
        }
    }
    return null;
};
const updateVideoCache = async (videos) => {
    for (let video of videos) {
        const id = video.id.videoId;
        const title = video.snippet.title;
        const description = video.snippet.description;
        const thumbnail = getBestThumbnail(video.snippet.thumbnails);
        const thumbnailUrl = thumbnail?.url ?? '';
        const etag = video.etag;
        const publishedTime = video.snippet.publishTime;
        await pool.query('INSERT INTO synthia_videos (id, title, description, thumbnail_url, published_at, etag) VALUES ($1, $2, $3, $4, $5, $6) ON CONFLICT (id) DO NOTHING', [id, title, description, thumbnailUrl, publishedTime, etag]);
    }
    await pool.query('UPDATE metadata SET last_video_check=$1 WHERE id=$2', [
        new Date(),
        1,
    ]);
};
APIRouter.get('/getLatestVideos', async (_, res) => {
    const url = 'https://www.googleapis.com/youtube/v3/search';
    const params = {
        part: 'snippet',
        maxResults: '50',
        order: 'date',
        q: 'Synthia',
        type: 'video',
    };
    const lastCheckResult = await pool.query('SELECT * FROM metadata');
    if (lastCheckResult &&
        lastCheckResult.rowCount &&
        lastCheckResult.rowCount > 0) {
        const lastCheck = lastCheckResult.rows[0].last_video_check;
        params.publishedAfter = lastCheck.toISOString();
    }
    const videos = await Array.fromAsync(getYouTubeResults(url, params));
    console.log('Found ' + videos.length.toString() + ' new videos. Cacheing...');
    await updateVideoCache(videos);
    const allVideos = await pool.query('SELECT * FROM synthia_videos');
    res.json(allVideos.rows);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3JvdXRlcy9hcGkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUNoQyxPQUFPLEVBQXFCLE1BQU0sRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNwRCxPQUFPLEVBQUUsSUFBSSxFQUFlLE1BQU0sSUFBSSxDQUFDO0FBU3ZDLE1BQU0sRUFBRSxDQUFDO0FBQ1QsTUFBTSxDQUFDLE1BQU0sU0FBUyxHQUFXLE1BQU0sRUFBRSxDQUFDO0FBRTFDLE1BQU0sZ0JBQWdCLEdBQUcsZ0JBQWdCLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUM7QUFDckwsTUFBTSxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsRUFBRSxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7QUFFNUMsS0FBSyxTQUFTLENBQUMsQ0FBQyxpQkFBaUIsQ0FDL0IsR0FBVyxFQUNYLE1BQThCO0lBRTlCLE1BQU0sS0FBSyxHQUFHLElBQUksZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzFDLEtBQUssQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBdUIsQ0FBQyxDQUFDO0lBQzVELEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBb0IsQ0FBQyxDQUFDO0lBQ25ELE9BQU8sSUFBSSxFQUFFLENBQUM7UUFDWixNQUFNLFFBQVEsR0FBRyxNQUFNLEtBQUssQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxD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